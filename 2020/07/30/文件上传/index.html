<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="大道至简"><title>文件上传 | 岳争</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">文件上传</h1><a id="logo" href="/.">岳争</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">文件上传</h1><div class="post-meta">2020-07-30<span> | </span><span class="category"><a href="/categories/JavaWeb/">JavaWeb</a></span></div><div class="post-content"><meta name="referrer" content="no-referrer"/>

<h1 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h1><p><img src="http://pic.netbian.com/uploads/allimg/190824/205524-1566651324f88b.jpg"></p>
<p>&emsp;&emsp;文件上传是项目开发中最常见的功能之一,几乎所有的网站都运用了文件上传的技术，进入我们来看看文件上传是如何实现的，我们想看一下最原生的Servlet版本的文件上传，在循序渐进的简化~~</p>
<h2 id="一、准备工作"><a href="#一、准备工作" class="headerlink" title="一、准备工作"></a>一、准备工作</h2><p>&emsp;&emsp;对于文件上传，浏览器再上传的过程中是将文件以流的形式提交到服务器的。</p>
<p>&emsp;&emsp;一般选择采用apache的开源工具common-fileupload这个文件上传组件</p>
<p>&emsp;&emsp;commons-fileupload是依赖于commons.io这个包，所有还需要下载这个包。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://mvnrepository.com/artifact/commons-io/commons-io/2.6">https://mvnrepository.com/artifact/commons-io/commons-io/2.6</a></li>
<li><a target="_blank" rel="noopener" href="https://mvnrepository.com/artifact/commons-fileupload/commons-fileupload/1.4">https://mvnrepository.com/artifact/commons-fileupload/commons-fileupload/1.4</a></li>
</ul>
<h2 id="二、使用类介绍"><a href="#二、使用类介绍" class="headerlink" title="二、使用类介绍"></a>二、使用类介绍</h2><p><strong>【文件上传的注意事项】</strong></p>
<ol>
<li>为保证服务器安全，上传文件应该放在外界无法访问的目录下，比如放于WEB-INF目录下</li>
<li>防止文件覆盖的现象发生，要为上传文件产生一个唯一的文件名</li>
<li>要限制上传文件的最大值</li>
<li>可以限制上传文件的类型，在收到上传文件名时，判断后缀名是否合法。</li>
</ol>
<p><strong>【需要用到的类详解】</strong></p>
<p>&emsp;&emsp;ServletFileUpload负责处理上传的文件数据，并将表单中每个输入项封装成一个FileItem对象，再使用ServletFileUpload对象解析请求时需要DiskFileItemFactory对象。所以，我们需要再进行解析工作前造好DiskFileItemFactory对象，通过SerletFileUpload对象的构造方法或setFileItemFactory()方法设置ServletFileUpload对象的FileItemFatory属性。</p>
<p><strong>FileItem类</strong></p>
<p>&emsp;&emsp;在HTML页面input必须有name  &lt; input type=”file” name=”filename” &gt;</p>
<p>&emsp;&emsp;表单如何包含一个文件上传输入项的话，这个表单的enctype属性就必须设置为multipart/form-data</p>
<p><strong>例如</strong></p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;div&gt;</span><br><span class="line">  &lt;form action=<span class="string">&quot;&quot;</span> enctype=<span class="string">&quot;multipart/form-data&quot;</span> method=<span class="string">&quot;post&quot;</span>&gt;</span><br><span class="line">    用户名:&lt;input type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;username&quot;</span>/&gt;&lt;br/&gt;</span><br><span class="line">    上传文件<span class="number">1</span>: &lt;input type=<span class="string">&quot;file&quot;</span> name=<span class="string">&quot;file1&quot;</span>/&gt;&lt;br/&gt;</span><br><span class="line">    上传文件<span class="number">2</span>: &lt;input type=<span class="string">&quot;file&quot;</span> name=<span class="string">&quot;file2&quot;</span>/&gt;&lt;br/&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;提交&quot;</span>&gt;</span><br><span class="line">  &lt;/form&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p><strong>【常用方法介绍】</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* isFormFileld方法用于判断FileItem类对象疯转的数据是一个普通文本表单，还是一个文件表单，如果时普通表单字段则返回true，否则返回false */</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isFormField</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// getFieldName方法用于返回表单标签name属性的值</span></span><br><span class="line"><span class="function">String <span class="title">getFieldName</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// getString方法用于将FileItem对象中保存的数据流以一个字符串返回</span></span><br><span class="line"><span class="function">String <span class="title">getString</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// getName方法用于获得文件上传字段中的文件名</span></span><br><span class="line"><span class="function">String <span class="title">getName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以流的形式返回上传文件的数据内容</span></span><br><span class="line"><span class="function">InputStream <span class="title">getInputStream</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* delete方法用来清空fileItem类对象中存放的主体内容，如果主体内容被保存在临时文件中，delete方法将删除该临时文件。*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span></span>; </span><br></pre></td></tr></table></figure>

<p><strong>ServletFileUpload类</strong></p>
<p>&emsp;&emsp;ServletFileUpload负责处理上传的文件数据，并将表单中每个输入项封装成一个FileItem对象中，使用其parseRequest(HttpServletRequest)方法可以通过表单中 每一个HTML标签提交的数据封装成一个FileItem对象，然后以List列表的形式返回。使用该方法处理上传文件简单易用。</p>
<h2 id="三、代码演示"><a href="#三、代码演示" class="headerlink" title="三、代码演示"></a>三、代码演示</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断时普通表单还是带文件的表单</span></span><br><span class="line">    <span class="keyword">if</span> (!ServletFileUpload.isMultipartContent(req))&#123;</span><br><span class="line">        <span class="comment">// 如果是普通表单 直接返回</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建上传文件的保存路径，建议保存在WEB-INF路径下，安全，用户无法直接访问上传的文件</span></span><br><span class="line">    String uploadPath = <span class="keyword">this</span>.getServletContext().getRealPath(<span class="string">&quot;/WEB-INF/upload&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;uploadPath:&quot;</span>+uploadPath);</span><br><span class="line">    File uploadFile = <span class="keyword">new</span> File(uploadPath);</span><br><span class="line">    <span class="comment">// 如果这个目录不存在就创建这个目录</span></span><br><span class="line">    <span class="keyword">if</span> (!uploadFile.exists())&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;创建文件目录&quot;</span>);</span><br><span class="line">        uploadFile.mkdir();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 缓存临时文件</span></span><br><span class="line">    <span class="comment">// 临时路径，如果文件超过了预期的大小，我们就把他放到一个临时文件中，过几天自动删除，或者提醒用户为永久</span></span><br><span class="line">    String tempPath = <span class="keyword">this</span>.getServletContext().getRealPath(<span class="string">&quot;/WEB-INF/temp&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;tempPath:&quot;</span>+tempPath);</span><br><span class="line">    File tempFile = <span class="keyword">new</span> File(tempPath);</span><br><span class="line">    <span class="comment">// 如果路径不存在则创建</span></span><br><span class="line">    <span class="keyword">if</span> (!tempFile.exists())&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;创建临时文件目录&quot;</span>);</span><br><span class="line">        tempFile.mkdir();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    处理上传的文件，一般都是用流来获取，我们可以通过request.getInputStream(),原生态的文件上传流获取，十分麻烦</span></span><br><span class="line"><span class="comment">    但是我们都建议使用apache的文件上传组件来实现commons-fileupload，他需要依赖commons.io</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 1.创建一个DiskFileItemFactory对象，处理文件上传路径和大小限制</span></span><br><span class="line">    DiskFileItemFactory factory = <span class="keyword">new</span> DiskFileItemFactory();</span><br><span class="line">        <span class="comment">// 通过这个工厂对象我们可以设置一个缓冲区，当上传文件大于这个文件的时候，将它放置到临时文件</span></span><br><span class="line">    factory.setSizeThreshold(<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">10</span>); <span class="comment">// 缓冲区大小为10M</span></span><br><span class="line">    factory.setRepository(tempFile); <span class="comment">// 临时目录保存文件，需要传入要设为临时目录的文件</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.获取ServletFileupload</span></span><br><span class="line">    ServletFileUpload upload = <span class="keyword">new</span> ServletFileUpload(factory);</span><br><span class="line">        <span class="comment">// 监听文件的上传进度</span></span><br><span class="line">    upload.setProgressListener(<span class="keyword">new</span> ProgressListener() &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            pBytesRead:文件已上传大小</span></span><br><span class="line"><span class="comment">            pContentLength:文件总大小</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">long</span> pBytesRead, <span class="keyword">long</span> pContentLength, <span class="keyword">int</span> pItem)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;总大小:&quot;</span>+pContentLength+<span class="string">&quot;已上传:&quot;</span>+pBytesRead);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">        <span class="comment">// 乱码问题</span></span><br><span class="line">    upload.setHeaderEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        <span class="comment">// 单个文件最大值 20M</span></span><br><span class="line">    upload.setFileSizeMax(<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">20</span>);</span><br><span class="line">        <span class="comment">// 总共上传空间 50M</span></span><br><span class="line">    upload.setSizeMax(<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">50</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.处理上传文件</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 把前端请求解析成一个Upload对象,需要从ServletFileItemFactory对象中获取</span></span><br><span class="line">        List&lt;FileItem&gt; fileItems = upload.parseRequest(req);</span><br><span class="line">        <span class="keyword">for</span> (FileItem fileItem : fileItems) &#123;</span><br><span class="line">            <span class="comment">// 判断上传的文件是普通表单还是带文件的表单</span></span><br><span class="line">            <span class="keyword">if</span> (fileItem.isFormField())&#123;</span><br><span class="line">                String fieldName = fileItem.getFieldName();</span><br><span class="line">                String value = fileItem.getString(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">                System.out.println(fieldName+<span class="string">&quot;:&quot;</span>+value);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">// 如果是文件表单</span></span><br><span class="line">                <span class="comment">//==================== 处理文件 =====================//</span></span><br><span class="line">                String uploadItemName = fileItem.getName();</span><br><span class="line">                <span class="comment">// 可能出现文件名不合法的问题</span></span><br><span class="line">                <span class="keyword">if</span> (uploadItemName.trim().equals(<span class="string">&quot;&quot;</span>)||uploadItemName==<span class="keyword">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                String fileName = uploadItemName.substring(uploadItemName.lastIndexOf(<span class="string">&quot;/&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">                String fileExtName = uploadItemName.substring(uploadItemName.lastIndexOf(<span class="string">&quot;.&quot;</span>) + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 使用UUID 来保证文件名的不重复</span></span><br><span class="line">                String uuidPath = UUID.randomUUID().toString();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//==================== 存放地址 =====================//</span></span><br><span class="line">                <span class="comment">// 保存到哪里？uploadPath</span></span><br><span class="line">                <span class="comment">// 文件真实存在的路径 realPath</span></span><br><span class="line">                String realPath = uploadPath+<span class="string">&quot;/&quot;</span>+uuidPath;</span><br><span class="line">                System.out.println(<span class="string">&quot;realPath:&quot;</span>+realPath);</span><br><span class="line">                <span class="comment">// 为每一个对应的文件创建一个文件夹</span></span><br><span class="line">                File realFile = <span class="keyword">new</span> File(realPath);</span><br><span class="line">                <span class="keyword">if</span> (realFile.exists())&#123;</span><br><span class="line">                    realFile.mkdir();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//==================== 文件处理完毕 =====================//</span></span><br><span class="line">                <span class="comment">// 获取上传流</span></span><br><span class="line">                InputStream inputStream = fileItem.getInputStream();</span><br><span class="line">                <span class="comment">// 创建一个文件输出流</span></span><br><span class="line">                FileOutputStream fileOutputStream = <span class="keyword">new</span> FileOutputStream(realPath);</span><br><span class="line">                <span class="comment">// 创建一个缓冲区</span></span><br><span class="line">                <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span> * <span class="number">1024</span>];</span><br><span class="line">                <span class="comment">// 判断是否读取完毕</span></span><br><span class="line">                <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">                <span class="comment">// 开始传输</span></span><br><span class="line">                <span class="keyword">while</span> ((len = inputStream.read(buffer))!=-<span class="number">1</span>)&#123;</span><br><span class="line">                    fileOutputStream.write(buffer,<span class="number">0</span>,len);</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">&quot;文件名为：&quot;</span>+fileName);</span><br><span class="line">                System.out.println(<span class="string">&quot;文件后缀为:&quot;</span>+fileExtName);</span><br><span class="line">                fileOutputStream.close();</span><br><span class="line">                inputStream.close();</span><br><span class="line">                fileItem.delete(); <span class="comment">//上传成功 清理临时文件</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        req.getRequestDispatcher(<span class="string">&quot;info.jsp&quot;</span>).forward(req,resp);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (FileUploadException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        doGet(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="四、代码优化"><a href="#四、代码优化" class="headerlink" title="四、代码优化"></a>四、代码优化</h2><p>&emsp;&emsp;是不是感觉异常复杂和庞大，接下来我们就来简化代码，把一些代码封装成一个方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断时普通表单还是带文件的表单</span></span><br><span class="line">        <span class="keyword">if</span> (!ServletFileUpload.isMultipartContent(req))&#123;</span><br><span class="line">            <span class="comment">// 如果是普通表单 直接返回</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 创建上传文件的保存路径，建议保存在WEB-INF路径下，安全，用户无法直接访问上传的文件</span></span><br><span class="line">        String uploadPath = <span class="keyword">this</span>.getServletContext().getRealPath(<span class="string">&quot;/WEB-INF/upload&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;uploadPath:&quot;</span>+uploadPath);</span><br><span class="line">        File uploadFile = <span class="keyword">new</span> File(uploadPath);</span><br><span class="line">        <span class="comment">// 如果这个目录不存在就创建这个目录</span></span><br><span class="line">        <span class="keyword">if</span> (!uploadFile.exists())&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;创建文件目录&quot;</span>);</span><br><span class="line">            uploadFile.mkdir();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 缓存临时文件</span></span><br><span class="line">        <span class="comment">// 临时路径，如果文件超过了预期的大小，我们就把他放到一个临时文件中，过几天自动删除，或者提醒用户为永久</span></span><br><span class="line">        String tempPath = <span class="keyword">this</span>.getServletContext().getRealPath(<span class="string">&quot;/WEB-INF/temp&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;tempPath:&quot;</span>+tempPath);</span><br><span class="line">        File tempFile = <span class="keyword">new</span> File(tempPath);</span><br><span class="line">        <span class="comment">// 如果路径不存在则创建</span></span><br><span class="line">        <span class="keyword">if</span> (!tempFile.exists())&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;创建临时文件目录&quot;</span>);</span><br><span class="line">            tempFile.mkdir();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        处理上传的文件，一般都是用流来获取，我们可以通过request.getInputStream(),原生态的文件上传流获取，十分麻烦</span></span><br><span class="line"><span class="comment">        但是我们都建议使用apache的文件上传组件来实现commons-fileupload，他需要依赖commons.io</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">        DiskFileItemFactory factory = getDiskFileItemFactory(tempFile);</span><br><span class="line">        ServletFileUpload upload = getServletFileUpload(factory);</span><br><span class="line">        uploadFile(req,upload,uploadPath);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileUploadException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        req.getRequestDispatcher(<span class="string">&quot;info.jsp&quot;</span>).forward(req,resp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        doGet(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DiskFileItemFactory <span class="title">getDiskFileItemFactory</span><span class="params">(File tempFile)</span></span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建一个DiskFileItemFactory对象，处理文件上传路径和大小限制</span></span><br><span class="line">        DiskFileItemFactory factory = <span class="keyword">new</span> DiskFileItemFactory();</span><br><span class="line">        <span class="comment">// 通过这个工厂对象我们可以设置一个缓冲区，当上传文件大于这个文件的时候，将它放置到临时文件</span></span><br><span class="line">        factory.setSizeThreshold(<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">10</span>); <span class="comment">// 缓冲区大小为10M</span></span><br><span class="line">        factory.setRepository(tempFile); <span class="comment">// 临时目录保存文件，需要传入要设为临时目录的文件</span></span><br><span class="line">        <span class="keyword">return</span> factory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletFileUpload <span class="title">getServletFileUpload</span><span class="params">(DiskFileItemFactory factory)</span></span>&#123;</span><br><span class="line">        <span class="comment">// 2.获取ServletFileupload</span></span><br><span class="line">        ServletFileUpload upload = <span class="keyword">new</span> ServletFileUpload(factory);</span><br><span class="line">        <span class="comment">// 监听文件的上传进度</span></span><br><span class="line">        upload.setProgressListener(<span class="keyword">new</span> ProgressListener() &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                pBytesRead:文件已上传大小</span></span><br><span class="line"><span class="comment">                pContentLength:文件总大小</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">long</span> pBytesRead, <span class="keyword">long</span> pContentLength, <span class="keyword">int</span> pItem)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;总大小:&quot;</span>+pContentLength+<span class="string">&quot;已上传:&quot;</span>+pBytesRead);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 乱码问题</span></span><br><span class="line">        upload.setHeaderEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        <span class="comment">// 单个文件最大值 20M</span></span><br><span class="line">        upload.setFileSizeMax(<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">20</span>);</span><br><span class="line">        <span class="comment">// 总共上传空间 50M</span></span><br><span class="line">        upload.setSizeMax(<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">50</span>);</span><br><span class="line">        <span class="keyword">return</span> upload;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">uploadFile</span><span class="params">(HttpServletRequest req,ServletFileUpload upload,String uploadPath)</span> <span class="keyword">throws</span> FileUploadException, IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 3.处理上传文件</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 把前端请求解析成一个Upload对象,需要从ServletFileItemFactory对象中获取</span></span><br><span class="line">        List&lt;FileItem&gt; fileItems = upload.parseRequest(req);</span><br><span class="line">        <span class="keyword">for</span> (FileItem fileItem : fileItems) &#123;</span><br><span class="line">            <span class="comment">// 判断上传的文件是普通表单还是带文件的表单</span></span><br><span class="line">            <span class="keyword">if</span> (fileItem.isFormField()) &#123;</span><br><span class="line">                String fieldName = fileItem.getFieldName();</span><br><span class="line">                String value = fileItem.getString(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">                System.out.println(fieldName + <span class="string">&quot;:&quot;</span> + value);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 如果是文件表单</span></span><br><span class="line">                <span class="comment">//==================== 处理文件 =====================//</span></span><br><span class="line">                String uploadItemName = fileItem.getName();</span><br><span class="line">                <span class="comment">// 可能出现文件名不合法的问题</span></span><br><span class="line">                <span class="keyword">if</span> (uploadItemName.trim().equals(<span class="string">&quot;&quot;</span>) || uploadItemName == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                String fileName = uploadItemName.substring(uploadItemName.lastIndexOf(<span class="string">&quot;/&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">                String fileExtName = uploadItemName.substring(uploadItemName.lastIndexOf(<span class="string">&quot;.&quot;</span>) + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 使用UUID 来保证文件名的不重复</span></span><br><span class="line">                String uuidPath = UUID.randomUUID().toString();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//==================== 存放地址 =====================//</span></span><br><span class="line">                <span class="comment">// 保存到哪里？uploadPath</span></span><br><span class="line">                <span class="comment">// 文件真实存在的路径 realPath</span></span><br><span class="line">                String realPath = uploadPath + <span class="string">&quot;/&quot;</span> + uuidPath;</span><br><span class="line">                System.out.println(<span class="string">&quot;realPath:&quot;</span> + realPath);</span><br><span class="line">                <span class="comment">// 为每一个对应的文件创建一个文件夹</span></span><br><span class="line">                File realFile = <span class="keyword">new</span> File(realPath);</span><br><span class="line">                <span class="keyword">if</span> (realFile.exists()) &#123;</span><br><span class="line">                    realFile.mkdir();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//==================== 文件处理完毕 =====================//</span></span><br><span class="line">                <span class="comment">// 获取上传流</span></span><br><span class="line">                InputStream inputStream = fileItem.getInputStream();</span><br><span class="line">                <span class="comment">// 创建一个文件输出流</span></span><br><span class="line">                FileOutputStream fileOutputStream = <span class="keyword">new</span> FileOutputStream(realPath);</span><br><span class="line">                <span class="comment">// 创建一个缓冲区</span></span><br><span class="line">                <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span> * <span class="number">1024</span>];</span><br><span class="line">                <span class="comment">// 判断是否读取完毕</span></span><br><span class="line">                <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">                <span class="comment">// 开始传输</span></span><br><span class="line">                <span class="keyword">while</span> ((len = inputStream.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    fileOutputStream.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">&quot;文件名为：&quot;</span> + fileName);</span><br><span class="line">                System.out.println(<span class="string">&quot;文件后缀为:&quot;</span> + fileExtName);</span><br><span class="line">                fileOutputStream.close();</span><br><span class="line">                inputStream.close();</span><br><span class="line">                fileItem.delete(); <span class="comment">//上传成功 清理临时文件</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;这样看起来我们的代码条理就会清晰了很多。</p>
<h2 id="五、SpringMVC再度简化"><a href="#五、SpringMVC再度简化" class="headerlink" title="五、SpringMVC再度简化"></a>五、SpringMVC再度简化</h2><p>&emsp;&emsp;springMVC 可以很好的支持文件上传，但是SpringMVC上下文中默认没有装配MultipartResolver，因此默认情况下其不能处理文件上传工作。如果想使用Spring的文件上传功能，则需要在上下文中配置MultipartResolver。</p>
<ul>
<li><p>Servlet3.0规范已经提供方法来处理文件上传，但这种上传需要在Servlet中完成。</p>
</li>
<li><p>而Spring MVC则提供了更简单的封装。</p>
</li>
<li><p>Spring MVC为文件上传提供了直接的支持，这种支持是用即插即用的MultipartResolver实现的。</p>
</li>
<li><p>Spring MVC使用Apache Commons FileUpload技术实现了一个MultipartResolver实现类：</p>
</li>
</ul>
<p>&emsp;&emsp;CommonsMultipartResolver。因此，SpringMVC的文件上传还需要依赖Apache Commons FileUpload的组件。 </p>
<ol>
<li>首先我们还是要导入文件上传的jar包，commons-fifileupload ， Maven会自动帮我们导入他的依赖包 commons-io包；</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2.配置web.xml 和Spring 配置文件</p>
<p>web.xml:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;web-app xmlns=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span><br><span class="line">         xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">         xsi:schemaLocation=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span><br><span class="line">         version=<span class="string">&quot;4.0&quot;</span>&gt;</span><br><span class="line">    &lt;servlet&gt;</span><br><span class="line">        &lt;servlet-name&gt;mvc&lt;/servlet-name&gt;</span><br><span class="line">        &lt;servlet-<span class="class"><span class="keyword">class</span>&gt;<span class="title">org</span>.<span class="title">springframework</span>.<span class="title">web</span>.<span class="title">servlet</span>.<span class="title">DispatcherServlet</span>&lt;/<span class="title">servlet</span>-<span class="title">class</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">init</span>-<span class="title">param</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">param</span>-<span class="title">name</span>&gt;<span class="title">contextConfigLocation</span>&lt;/<span class="title">param</span>-<span class="title">name</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">param</span>-<span class="title">value</span>&gt;<span class="title">classpath</span>:<span class="title">application</span>.<span class="title">xml</span>&lt;/<span class="title">param</span>-<span class="title">value</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">init</span>-<span class="title">param</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">load</span>-<span class="title">on</span>-<span class="title">startup</span>&gt;1&lt;/<span class="title">load</span>-<span class="title">on</span>-<span class="title">startup</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;/<span class="title">servlet</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">servlet</span>-<span class="title">mapping</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">servlet</span>-<span class="title">name</span>&gt;<span class="title">mvc</span>&lt;/<span class="title">servlet</span>-<span class="title">name</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">url</span>-<span class="title">pattern</span>&gt;/&lt;/<span class="title">url</span>-<span class="title">pattern</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;/<span class="title">servlet</span>-<span class="title">mapping</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">web</span>-<span class="title">app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>application.xml:</p>
<p>【<strong>注意！！！这个bena的id必须为：<em>multipartResolver</em>， 否则上传文件会报400的错误！在这里栽过坑,教训！</strong>】</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:mvc</span>=<span class="string">&quot;http://www.springframework.org/schema/mvc&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/context </span></span></span><br><span class="line"><span class="string"><span class="tag">https://www.springframework.org/schema/context/spring-context.xsd </span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/mvc </span></span></span><br><span class="line"><span class="string"><span class="tag">https://www.springframework.org/schema/mvc/spring-mvc.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.yue.controller&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:default-servlet-handler</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:annotation-driven</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span> <span class="attr">id</span>=<span class="string">&quot;internalResourceViewResolver&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;prefix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;WEB-INF/jsp/&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;suffix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;.jsp&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.multipart.commons.CommonsMultipartResolver&quot;</span> <span class="attr">id</span>=<span class="string">&quot;multipartResolver&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        设置编码--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;defaultEncoding&quot;</span> <span class="attr">value</span>=<span class="string">&quot;utf-8&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        上传文件最大容量--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxUploadSize&quot;</span> <span class="attr">value</span>=<span class="string">&quot;10485760&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxInMemorySize&quot;</span> <span class="attr">value</span>=<span class="string">&quot;40960&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>CommonsMultipartFile 的 常用方法：</strong></p>
<p>**String getOriginalFilename()**：获取上传文件的原名</p>
<p>**InputStream getInputStream()**：获取文件流</p>
<p>**void transferTo(File dest)**：将上传文件保存到一个目录文件中</p>
<ol start="3">
<li>编写前端页面</li>
</ol>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;title&gt;$Title$&lt;/title&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;form action=<span class="string">&quot;$&#123;pageContext.request.contextPath&#125;/upload&quot;</span> enctype=<span class="string">&quot;multipart/form-data&quot;</span> method=<span class="string">&quot;post&quot;</span>&gt;</span><br><span class="line">      用户名:&lt;input type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;username&quot;</span>/&gt;&lt;br/&gt;</span><br><span class="line">      上传文件: &lt;input type=<span class="string">&quot;file&quot;</span> name=<span class="string">&quot;file&quot;</span>/&gt;&lt;br/&gt;</span><br><span class="line">      &lt;input type=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;提交&quot;</span>&gt; | &lt;input type=<span class="string">&quot;reset&quot;</span> value=<span class="string">&quot;重置&quot;</span>&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>编写Controller</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">@RequestParam(&quot;file&quot;) 将name=file 控件得到的文件封装成CommonsMultipartFile对象</span></span><br><span class="line"><span class="comment">如果是批量上传 把CommonsMultipartFile 改为CommonsMultipartFile数组即可</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/upload&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">uploadFile</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> CommonsMultipartFile file, HttpServletRequest request)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取文件名</span></span><br><span class="line">    String filename = file.getOriginalFilename();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断是否为空</span></span><br><span class="line">    <span class="keyword">if</span> (filename.equals(<span class="string">&quot;&quot;</span>))&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;redirect:/index.jsp&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;上传的文件名为:&quot;</span>+ filename);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置上传保存路径</span></span><br><span class="line">    String realPath = request.getServletContext().getRealPath(<span class="string">&quot;/upload&quot;</span>);</span><br><span class="line">    File realPathFile = <span class="keyword">new</span> File(realPath);</span><br><span class="line">    <span class="keyword">if</span> (!realPathFile.exists())&#123;</span><br><span class="line">        realPathFile.mkdir();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;上传文件的保存地址为:&quot;</span>+realPathFile);</span><br><span class="line"></span><br><span class="line">    InputStream inputStream = file.getInputStream();</span><br><span class="line">    FileOutputStream fileOutputStream = <span class="keyword">new</span> FileOutputStream(<span class="keyword">new</span> File(realPath,filename));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">while</span> ((len=inputStream.read(buffer))!=-<span class="number">1</span>)&#123;</span><br><span class="line">        fileOutputStream.write(buffer,<span class="number">0</span>,len);</span><br><span class="line">        fileOutputStream.flush();</span><br><span class="line">    &#125;</span><br><span class="line">    inputStream.close();</span><br><span class="line">    fileOutputStream.close();</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;redirect:/index.jsp&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;这样相比我们原生的Servlet版本是不是简单了很多了呢，<strong>但是，还有一个<em>终极简化</em>！</strong></p>
<p><strong>终极版本:采用ifile.Transto 来保存上传的文件</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/upload2&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">uploadFile2</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> CommonsMultipartFile file, HttpServletRequest reques)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String realPath = reques.getServletContext().getRealPath(<span class="string">&quot;/upload&quot;</span>);</span><br><span class="line">    File realFile = <span class="keyword">new</span> File(realPath);</span><br><span class="line">    <span class="keyword">if</span> (!realFile.exists())&#123;</span><br><span class="line">        realFile.mkdir();</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;文件的上传地址为:&quot;</span>+realPath);</span><br><span class="line">    file.transferTo(<span class="keyword">new</span> File(realPath+<span class="string">&quot;/&quot;</span>+file.getOriginalFilename()));</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;redirect:/index.jsp&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;惊不惊讶！相比Servlet原生的文件上传简直就是天壤之别~~~</p>
</div><div class="tags"><a href="/tags/%E7%AC%94%E8%AE%B0/"><i class="fa fa-tag"></i>笔记</a></div><div class="post-nav"><a class="pre" href="/2020/08/10/Redis%20%E4%B8%8B/">长达数万子的Redis大总结（下）</a><a class="next" href="/2020/07/28/Servlet%E8%AF%A6%E8%A7%A3/">Servlet详解</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://example.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/JWT/">JWT</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaWeb/">JavaWeb</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Leetcode/">Leetcode</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MyBatis/">MyBatis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Shiro/">Shiro</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Vue/">Vue</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/html/">html</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/json/">json</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/%E7%AC%94%E8%AE%B0/" style="font-size: 15px;">笔记</a> <a href="/tags/JWT/" style="font-size: 15px;">JWT</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 15px;">算法</a> <a href="/tags/Spring/" style="font-size: 15px;">Spring</a> <a href="/tags/%E5%BC%82%E5%B8%B8%E6%97%A5%E5%BF%97/" style="font-size: 15px;">异常日志</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 15px;">数据结构</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 15px;">多线程</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/07/12/MySQL%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/">最详细的MySql配置文件详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/07/shiro(%E4%BA%94)%E6%95%B4%E5%90%88SpringBoot/">Shiro入门(五)：整合SpringBoot</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/05/shiro(%E5%9B%9B)%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">Shiro入门(四)：认证源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/03/shiro(%E4%B8%89)%E8%AE%A4%E8%AF%81/">Shiro入门(三)：授权</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/03/shiro(%E4%BA%8C)%E8%87%AA%E5%AE%9A%E4%B9%89Reaml%E4%B8%8E%E5%8A%A0%E5%AF%86/">Shiro入门(二)：自定义Reaml与加密</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/02/shiro(%E4%B8%80)%E6%8E%88%E6%9D%83/">Shiro入门(一)：授权</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/19/Vue%E8%BF%9B%E9%98%B6/">Vue进阶</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/19/JWT%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/">JWT快速入门</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/16/Leetcode-01-%E4%B8%A4%E6%95%B0%E4%B9%8B%E5%92%8C/">Leetcode-01-两数之和</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/10/16/Vue%E5%85%A5%E9%97%A8/">Vue-入门</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">岳争.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>